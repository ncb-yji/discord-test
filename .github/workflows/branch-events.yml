name: Notify Discord on Branch Create/Delete (main, release, develop only)

on:
  create:
    branches:
      - '**'
  delete:
    branches:
      - '**'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord for selected branches
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          EVENT_NAME: ${{ github.event_name }}
          REF_TYPE: ${{ github.event.ref_type }}
          REF_NAME: ${{ github.ref_name }}
          AUTHOR: ${{ github.actor }}
        run: |
          # 브랜치가 아닌 경우 무시 (예: tag 생성 이벤트 등)
          if [[ "$REF_TYPE" != "branch" ]]; then
            echo "🚫 감지된 리소스는 브랜치가 아닙니다: $REF_TYPE. 종료."
            exit 0
          fi

          # GitHub ID → 닉네임 매핑
          case "$AUTHOR" in
            ncb-yji) NICKNAME="양정인" ;;
            leehj7739) NICKNAME="이희준" ;;
            jihun-01) NICKNAME="최지훈" ;;
            naGGuri) NICKNAME="나희수" ;;
            hyeonjinleeluck) NICKNAME="이현진" ;;
            *) NICKNAME="$AUTHOR" ;;
          esac

          # 감시 대상 브랜치만 알림
          if [[ "$REF_NAME" != "main" && "$REF_NAME" != "release" && "$REF_NAME" != "develop" ]]; then
            echo "📭 감시 대상이 아닌 브랜치: $REF_NAME. 알림 생략."
            exit 0
          fi

          if [ "$EVENT_NAME" = "create" ]; then
            MESSAGE="🆕 **브랜치 생성**\n👤 작성자: \`$NICKNAME\`\n🌿 브랜치: \`$REF_NAME\`"
          elif [ "$EVENT_NAME" = "delete" ]; then
            MESSAGE="🗑️ **브랜치 삭제**\n👤 작성자: \`$NICKNAME\`\n🌿 브랜치: \`$REF_NAME\`"
          else
            MESSAGE="⚠️ 알 수 없는 이벤트 \`$EVENT_NAME\`"
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"$MESSAGE\", \"username\": \"BranchBot-$REF_NAME\"}" \
               "$DISCORD_WEBHOOK"
