name: Notify Discord on Push/Merge to main, release, develop

on:
  push:
    branches:
      - main
      - release
      - develop

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 전체 이력 필요

      - name: Send notification to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_BEFORE: ${{ github.event.before }}
          GITHUB_AFTER: ${{ github.event.after }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          # 닉네임 매핑
          case "$GITHUB_ACTOR" in
            ncb-yji) NICKNAME="양정인" ;;
            leehj7739) NICKNAME="이희준" ;;
            jihun-01) NICKNAME="최지훈" ;;
            naGGuri) NICKNAME="나희수" ;;
            hyeonjinleeluck) NICKNAME="이현진" ;;
            *) NICKNAME="$GITHUB_ACTOR" ;;
          esac

          # 커밋 목록 추출
          COMMITS=$(git log --pretty=format:"- \`%h\` %s" $GITHUB_BEFORE..$GITHUB_AFTER || echo "")
          LAST_COMMIT_MSG=$(git log -1 --pretty=%s)
          LAST_COMMIT_HASH=$(git log -1 --pretty=%h)

          # 커밋이 없다면 마지막 커밋 하나라도 출력
          if [ -z "$COMMITS" ]; then
            COMMITS="- \`$LAST_COMMIT_HASH\` $LAST_COMMIT_MSG"
          fi

          # Merge 여부 감지 (메시지와 커밋 수로 추정)
          COMMIT_COUNT=$(git rev-list --count $GITHUB_BEFORE..$GITHUB_AFTER)
          IS_MERGE=false

          if echo "$LAST_COMMIT_MSG" | grep -Eq "^Merge (branch|pull request)"; then
            IS_MERGE=true
          elif [ "$COMMIT_COUNT" -gt 1 ]; then
            IS_MERGE=true
          fi

          if $IS_MERGE; then
            TITLE="🔀 MERGE : (source) → \`$GITHUB_REF_NAME\`"
          else
            TITLE="📌 PUSH : \`$GITHUB_REF_NAME\`"
          fi

          MESSAGE="$TITLE\n👤 작성자: \`$NICKNAME\`\n$COMMITS"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"$MESSAGE\", \"username\": \"GitNotifier\"}" \
               "$DISCORD_WEBHOOK"
