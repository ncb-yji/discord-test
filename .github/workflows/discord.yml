name: Notify Discord on Push/Merge to main, release, develop

on:
  push:
    branches:
      - main
      - release
      - develop

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # merge ê°ì§€ì™€ ì—¬ëŸ¬ ì»¤ë°‹ì„ ìœ„í•´ ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš”

      - name: Send notification to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_BEFORE: ${{ github.event.before }}
          GITHUB_AFTER: ${{ github.event.after }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          # ë‹‰ë„¤ì„ ë§¤í•‘
          case "$GITHUB_ACTOR" in
            ncb-yji) NICKNAME="ì–‘ì •ì¸" ;;
            leehj7739) NICKNAME="ì´í¬ì¤€" ;;
            jihun-01) NICKNAME="ìµœì§€í›ˆ" ;;
            naGGuri) NICKNAME="ë‚˜í¬ìˆ˜" ;;
            hyeonjinleeluck) NICKNAME="ì´í˜„ì§„" ;;
            *) NICKNAME="$GITHUB_ACTOR" ;;
          esac

          # ì»¤ë°‹ ë©”ì‹œì§€ ìˆ˜ì§‘
          COMMITS=$(git log --pretty=format:"- \`%h\` %s" $GITHUB_BEFORE..$GITHUB_AFTER)

          # MERGE ì—¬ë¶€ ê°ì§€
          IS_MERGE=false
          MERGE_FROM=""
          MERGE_TO="$GITHUB_REF_NAME"

          # ê°€ì¥ ë§ˆì§€ë§‰ ì»¤ë°‹ ë©”ì‹œì§€
          LAST_COMMIT_MSG=$(git log -1 --pretty=%s)

          if echo "$LAST_COMMIT_MSG" | grep -qE "^Merge (branch|pull request)"; then
            IS_MERGE=true
            # Merge branch 'source' into 'target'
            MERGE_FROM=$(echo "$LAST_COMMIT_MSG" | sed -n "s/^Merge branch '\(.*\)' into.*/\1/p")
            # GitHub Desktopì´ë‚˜ squash mergeì¸ ê²½ìš° ëŒ€ë¹„
            [ -z "$MERGE_FROM" ] && MERGE_FROM="(unknown)"
          fi

          if $IS_MERGE; then
            TITLE="ğŸ”€ MERGE : \`$MERGE_FROM\` â†’ \`$MERGE_TO\`"
          else
            TITLE="ğŸ“Œ PUSH : \`$MERGE_TO\`"
          fi

          MESSAGE="$TITLE\nğŸ‘¤ ì‘ì„±ì: \`$NICKNAME\`\n$COMMITS"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"$MESSAGE\", \"username\": \"GitNotifier\"}" \
               "$DISCORD_WEBHOOK"
